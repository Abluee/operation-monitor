<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.monitor.module.execute.mapper.BizTaskLogMapper">

    <!-- ResultMap for BizTaskLog entity -->
    <resultMap id="BaseResultMap" type="com.monitor.module.execute.entity.BizTaskLog">
        <id column="id" property="id"/>
        <result column="task_id" property="taskId"/>
        <result column="type_id" property="typeId"/>
        <result column="exec_time" property="execTime"/>
        <result column="exec_status" property="execStatus"/>
        <result column="trigger_type" property="triggerType"/>
        <result column="exec_sql" property="execSql"/>
        <result column="exec_result" property="execResult"/>
        <result column="error_msg" property="errorMsg"/>
        <result column="duration_ms" property="durationMs"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- ResultMap with task info -->
    <resultMap id="LogWithTaskResultMap" extends="BaseResultMap" type="com.monitor.module.execute.entity.BizTaskLog">
        <association property="bizTask" javaType="com.monitor.module.task.entity.BizTask">
            <id column="task_id" property="id"/>
            <result column="task_name" property="taskName"/>
            <result column="task_code" property="taskCode"/>
        </association>
    </resultMap>

    <!-- Base columns -->
    <sql id="Base_Column_List">
        id, task_id, type_id, exec_time, exec_status, trigger_type, exec_sql,
        exec_result, error_msg, duration_ms, create_time
    </sql>

    <!-- Select by task id -->
    <select id="selectByTaskId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM biz_task_log
        WHERE task_id = #{taskId}
        ORDER BY exec_time DESC
    </select>

    <!-- Select by time range -->
    <select id="selectByTimeRange" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM biz_task_log
        WHERE task_id = #{taskId}
          AND exec_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY exec_time DESC
    </select>

    <!-- Select by task id with pagination -->
    <select id="selectPageByTaskId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM biz_task_log
        WHERE task_id = #{taskId}
        ORDER BY exec_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- Select recent logs -->
    <select id="selectRecentLogs" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM biz_task_log
        WHERE create_time &gt;= #{startTime}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <!-- Select failed logs for alert -->
    <select id="selectFailedLogsForAlert" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM biz_task_log
        WHERE exec_status = 0
          AND create_time &gt;= #{startTime}
        ORDER BY create_time DESC
    </select>

    <!-- Count by task id -->
    <select id="countByTaskId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM biz_task_log
        WHERE task_id = #{taskId}
    </select>

    <!-- Count by status in time range -->
    <select id="countByStatusAndTimeRange" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM biz_task_log
        WHERE task_id = #{taskId}
          AND exec_status = #{execStatus}
          AND exec_time BETWEEN #{startTime} AND #{endTime}
    </select>

    <!-- Delete old logs -->
    <delete id="deleteOldLogs">
        DELETE FROM biz_task_log
        WHERE create_time &lt; #{beforeTime}
    </delete>

</mapper>
